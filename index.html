<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MONITORING KUALITAS UDARA - Analytics</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
body{background:#0b0e14;font-family:Inter,sans-serif;color:#d8d9da}
.card-grafana{background:#181b1f;border:1px solid #26292e;border-radius:4px}
.nav-active{border-bottom:3px solid #3274d9;color:#3274d9}
.active-filter{background:#3274d9;color:white}
</style>
</head>

<body class="p-4 lg:p-8">
<div class="max-w-7xl mx-auto">

<!-- HEADER -->
<header class="flex justify-between items-center mb-6 bg-[#111217] p-4 border border-[#26292e]">
  <h1 class="text-xl font-black text-white">
    MONITORING KUALITAS UDARA 
    <span class="text-[#3274d9] text-xs">Kelompok 11</span>
  </h1>
  <nav class="flex gap-6">
    <button id="btn-dashboard" onclick="showSection('dashboard')" class="nav-active text-xs font-bold uppercase">Monitor</button>
    <button id="btn-recap" onclick="showSection('recap')" class="text-xs font-bold uppercase text-slate-500">Analitik</button>
  </nav>
</header>

<!-- DASHBOARD -->
<div id="section-dashboard" class="space-y-4">

  <!-- SENSOR -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div class="card-grafana p-4">
      <p class="text-xs text-rose-400">Suhu</p>
      <h3 id="dash-temp" class="text-2xl font-black">-- °C</h3>
    </div>
    <div class="card-grafana p-4">
      <p class="text-xs text-cyan-400">Kelembapan</p>
      <h3 id="dash-hum" class="text-2xl font-black">-- %</h3>
    </div>
    <div class="card-grafana p-4">
      <p class="text-xs text-emerald-400">CO₂</p>
      <h3 id="dash-co2" class="text-2xl font-black">-- ppm</h3>
    </div>
    <div class="card-grafana p-4">
      <p class="text-xs text-amber-400">Debu</p>
      <h3 id="dash-dust" class="text-2xl font-black">-- µg/m³</h3>
    </div>
  </div>

  <!-- 2 FRAME KONDISI UDARA -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

    <!-- STATUS -->
    <div class="card-grafana p-4">
      <p class="text-xs text-slate-400">Kondisi Udara</p>
      <h2 id="status-label" class="text-2xl font-black">MENUNGGU DATA...</h2>
      <p id="last-update" class="text-xs text-slate-500"></p>
    </div>

    <!-- KETERANGAN -->
    <div class="card-grafana p-4">
      <p class="text-xs text-slate-400">Keterangan Kondisi</p>
      <h2 id="status-desc" class="text-2xl font-black text-slate-400">Belum ada data</h2>
      <p id="status-note" class="text-xs text-slate-500"></p>
    </div>

  </div>
</div>

<!-- ANALYTICS -->
<div id="section-recap" class="hidden">
<div class="card-grafana p-6">

  <!-- FILTER -->
  <div class="flex justify-between mb-4">
    <p class="text-xs font-bold uppercase">Grafik Data</p>
    <div class="flex gap-1">
      <button class="f-btn active-filter px-3 py-1 text-xs" onclick="setFilter('sec',this)">Live</button>
      <button class="f-btn px-3 py-1 text-xs" onclick="setFilter('min',this)">Menit</button>
      <button class="f-btn px-3 py-1 text-xs" onclick="setFilter('hour',this)">Jam</button>
      <button class="f-btn px-3 py-1 text-xs" onclick="setFilter('day',this)">Hari</button>
    </div>
  </div>

  <!-- CHART -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="card-grafana p-4 h-[260px]"><canvas id="chartTemp"></canvas></div>
    <div class="card-grafana p-4 h-[260px]"><canvas id="chartHum"></canvas></div>
    <div class="card-grafana p-4 h-[260px]"><canvas id="chartCO2"></canvas></div>
    <div class="card-grafana p-4 h-[260px]"><canvas id="chartDust"></canvas></div>
  </div>

  <!-- TABLE -->
  <div class="overflow-x-auto border border-[#26292e] rounded">
    <table class="w-full text-xs">
      <thead class="bg-[#111217] text-slate-400">
        <tr>
          <th class="p-3">Waktu</th>
          <th class="p-3">Suhu</th>
          <th class="p-3">Lembab</th>
          <th class="p-3">CO₂</th>
          <th class="p-3">Debu</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

</div>
</div>

</div>

<script>
// FIREBASE
firebase.initializeApp({
  apiKey:"AIzaSyAD1QPvINjWitgo_Rrj44s47Pr4S1BU_lM",
  databaseURL:"https://monitoring-kualitas-udar-8ad9d-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=firebase.database();

let logData=JSON.parse(localStorage.getItem('iaq_logs'))||[];
let currentFilter='sec';

// CHART
function makeChart(id,color){
  return new Chart(document.getElementById(id),{
    type:'line',
    data:{labels:[],datasets:[{data:[],borderColor:color,backgroundColor:color+'33',fill:true,tension:.3}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
  });
}

const chartTemp=makeChart('chartTemp','#f03e3e');
const chartHum=makeChart('chartHum','#339af0');
const chartCO2=makeChart('chartCO2','#51cf66');
const chartDust=makeChart('chartDust','#fcc419');

// FIREBASE LISTENER
db.ref('log_sensor').limitToLast(1).on('child_added',snap=>{
  const v=snap.val(); if(!v)return;

  dash('temp',`${v.suhu} °C`);
  dash('hum',`${v.kelembapan} %`);
  dash('co2',`${v.co2} ppm`);
  dash('dust',`${v.debu} µg/m³`);

  const status=(v.status||"").toUpperCase();
  const sEl=statusLabel=document.getElementById('status-label');
  const dEl=document.getElementById('status-desc');
  const nEl=document.getElementById('status-note');

  if(status==="BAIK"){
    sEl.textContent="UDARA BAIK";
    sEl.className="text-2xl font-black text-emerald-400";
    dEl.textContent="Kondisi Aman";
    dEl.className="text-2xl font-black text-emerald-300";
    nEl.textContent="Kualitas udara normal dan layak untuk aktivitas.";
  }else if(status==="BURUK"){
    sEl.textContent="UDARA BURUK";
    sEl.className="text-2xl font-black text-rose-500";
    dEl.textContent="Kondisi Tidak Sehat";
    dEl.className="text-2xl font-black text-rose-400";
    nEl.textContent="Kualitas udara menurun.";
  }else{
    sEl.textContent="STATUS TIDAK DIKETAHUI";
    sEl.className="text-2xl font-black text-slate-400";
    dEl.textContent="Belum ada data";
    dEl.className="text-2xl font-black text-slate-400";
    nEl.textContent="";
  }

  document.getElementById('last-update').textContent="Update "+new Date().toLocaleTimeString();
});

function dash(id,val){document.getElementById(`dash-${id}`).textContent=val;}
function showSection(s){
  sectionDashboard.classList.toggle('hidden',s!=='dashboard');
  sectionRecap.classList.toggle('hidden',s!=='recap');
}
</script>
</body>
</html>
