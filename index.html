<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAQ Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Menggunakan font Inter */
        :root { font-family: 'Inter', sans-serif; }
        
        /* Gaya khusus untuk Tabel Recap */
        .log-table th {
            @apply px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider bg-gray-700;
        }
    </style>
    <script>
        // ==========================================
        // 1. FIREBASE CONFIGURATION (WAJIB DIGANTI)
        // ==========================================
        let firebaseConfig = {
            // Placeholder: GANTI dengan FIREBASE CONFIG Anda dari kode ESP32
            apiKey: "AIzaSyAD1QPvINjWitgo_Rrj44s47Pr4S1BU_lM",
            databaseURL: "https://monitoring-kualitas-udar-8ad9d-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "monitoring-kualitas-udar-8ad9d",
        };
        
        // Menggunakan konfigurasi lingkungan Canvas jika tersedia
        if (typeof __firebase_config !== 'undefined') {
            try {
                // Konfigurasi dari lingkungan Canvas biasanya untuk Firestore, 
                // tapi kita tetap gunakan jika ada
                const envConfig = JSON.parse(__firebase_config);
                firebaseConfig = { ...firebaseConfig, ...envConfig };
            } catch (e) {
                console.error("Gagal memparsing __firebase_config:", e);
            }
        }


        // ==========================================
        // 2. GLOBAL VARIABLES
        // ==========================================
        const SENSORS = ['suhu', 'kelembaban', 'debu', 'co2'];
        const SENSOR_LABELS = {
            suhu: { label: 'Temperature (°C)', unit: ' °C', color: 'rgb(255, 99, 132)' }, // Merah
            kelembaban: { label: 'Humidity (%)', unit: ' %', color: 'rgb(54, 162, 235)' }, // Biru
            debu: { label: 'Dust (mg/m³)', unit: ' mg/m³', color: 'rgb(255, 205, 86)' }, // Kuning
            co2: { label: 'CO2 (ppm)', unit: ' ppm', color: 'rgb(75, 192, 192)' } // Hijau
        };

        let app;
        let db;
        let currentView = 'dashboard'; // Variabel untuk melacak tampilan aktif
        let currentRecapPeriod = 'minute'; // New state: 'minute', 'hourly', 'daily', 'monthly'
        
        // Jumlah entri yang ditampilkan di tabel log untuk setiap periode
        const LOG_ENTRY_COUNT = 60; // 60 minutes (1 hour)
        const HOURLY_RECAP_COUNT = 24; // 24 hours (1 day)
        const DAILY_RECAP_COUNT = 7; // 7 days (1 week)
        const MONTHLY_RECAP_COUNT = 12; // 12 months (1 year)

        // ==========================================
        // 3. UTILITY FUNCTIONS
        // ==========================================

        /**
         * Mengatur tampilan mana yang aktif ('dashboard' atau 'recap')
         */
        function switchView(view) {
            currentView = view;
            document.getElementById('dashboard-section').classList.toggle('hidden', view !== 'dashboard');
            document.getElementById('recap-section').classList.toggle('hidden', view !== 'recap');
            
            // Update button styles
            document.getElementById('nav-dashboard').className = view === 'dashboard' 
                ? "px-6 py-2 rounded-full font-semibold transition duration-300 bg-blue-600 hover:bg-blue-700 text-white shadow-lg"
                : "px-6 py-2 rounded-full font-semibold transition duration-300 bg-gray-700 hover:bg-gray-600 text-gray-300";
            
            document.getElementById('nav-recap').className = view === 'recap' 
                ? "px-6 py-2 rounded-full font-semibold transition duration-300 bg-blue-600 hover:bg-blue-700 text-white shadow-lg"
                : "px-6 py-2 rounded-full font-semibold transition duration-300 bg-gray-700 hover:bg-gray-600 text-gray-300";

            // If switching to recap, render log data and set initial period
            if (view === 'recap') {
                setRecapPeriod(currentRecapPeriod); 
            }
        }

        /**
         * Mendapatkan waktu saat ini dalam format lokal (WIB/WITA/WIT).
         */
        function getCurrentFormattedTime() {
            return new Date().toLocaleString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            });
        }
        
        function getStatusColor(status) {
            switch (status) {
                case 'Bersih': return 'bg-green-600'; // Warna untuk mode gelap
                case 'Normal': return 'bg-yellow-600';
                case 'Buruk': return 'bg-red-600';
                default: return 'bg-gray-600';
            }
        }
        
        /**
         * Mengubah data log menjadi format CSV dan memicu unduhan.
         */
        function downloadLogAsCSV() {
            const period = currentRecapPeriod;
            const logs = getLogData(period);
            
            if (logs.length === 0) {
                console.warn("Tidak ada data log untuk diunduh.");
                return;
            }

            // 1. Header CSV
            const headers = [
                `Waktu (Per ${period})`, 
                "Suhu (C)", 
                "Kelembaban (%)", 
                "Debu (mg/m³)", 
                "CO2 (ppm)", 
                "Status"
            ];
            let csvContent = headers.join(";") + "\n"; // Menggunakan semicolon sebagai delimiter

            // 2. Data CSV
            logs.forEach(log => {
                // Wrap timestamp in quotes for safety in CSV
                const row = [
                    `"${log.timestamp}"`,
                    log.suhu,
                    log.kelembaban,
                    log.debu,
                    log.co2,
                    log.status
                ];
                csvContent += row.join(";") + "\n";
            });

            // 3. Memicu Unduhan
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            
            const now = new Date();
            // Nama file yang lebih spesifik
            const filename = `IAQ_Recap_${period}_${now.toISOString().split('T')[0]}.csv`;
            
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }


        // ==========================================
        // 4. DATA FETCHING & RENDERING
        // ==========================================
        
        // --- FETCH REALTIME STATUS ---
        function listenForCurrentStatus() {
            // Mendengarkan perubahan pada path /IAQ/
            db.ref('/IAQ').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // *** Mengambil waktu real-time saat snapshot diterima ***
                    const realtimeTimestamp = getCurrentFormattedTime();
                    
                    // Update header status
                    const statusDiv = document.getElementById('iaq-status');
                    const color = getStatusColor(data.status);
                    statusDiv.className = `p-4 text-white font-bold rounded-xl shadow-xl text-center mb-4 ${color}`;
                    statusDiv.innerHTML = `
                        <p class="text-2xl">${data.status.toUpperCase()}</p>
                        <p class="text-sm mt-1">Kualitas Udara Terkini</p>
                    `;

                    // Update timestamp display
                    const timeDiv = document.getElementById('last-updated-time');
                    timeDiv.innerHTML = `<p class="text-sm text-gray-400 text-center mt-2">Data terakhir diperbarui pada: <strong class="text-gray-100">${realtimeTimestamp}</strong></p>`;
                    
                    // Update sensor cards
                    let cardsHtml = '';
                    SENSORS.forEach(key => {
                        const info = SENSOR_LABELS[key];
                        const value = data[key] ? data[key].toFixed(key === 'debu' ? 3 : 1) : 'N/A';
                        
                        // Menentukan warna nilai untuk kontras yang menyala
                        const valueColor = key === 'suhu' ? 'text-red-400' : 
                                             key === 'kelembaban' ? 'text-blue-400' :
                                             key === 'debu' ? 'text-yellow-400' : 'text-green-400';

                        cardsHtml += `
                            <div class="bg-gray-800 p-6 rounded-xl shadow-lg text-center border border-gray-700">
                                <p class="text-xs font-semibold uppercase text-gray-400">${info.label.split('(')[0].trim()}</p>
                                <p class="text-4xl font-extrabold mt-2 ${valueColor}">${value}</p>
                                <p class="text-sm text-gray-500">${info.unit.trim()}</p>
                            </div>
                        `;
                    });
                    document.getElementById('sensor-cards').innerHTML = cardsHtml;
                }
            }, (error) => {
                console.error("Error reading IAQ data:", error);
                document.getElementById('iaq-status').textContent = "Status: Gagal memuat data.";
            });
        }
        
        // --- LOG DATA SIMULATION FUNCTIONS ---
        
        /**
         * Menghasilkan data log simulasi per menit (60 entri).
         */
        function generateSimulatedMinuteLog(count = LOG_ENTRY_COUNT) {
            const logs = [];
            let now = new Date();
            for (let i = 0; i < count; i++) {
                const timestamp = new Date(now.getTime() - i * 60000); // Interval 1 menit
                logs.push({
                    timestamp: timestamp.toLocaleString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' }),
                    suhu: (Math.random() * 5 + 20).toFixed(1),
                    kelembaban: (Math.random() * 10 + 70).toFixed(1),
                    debu: (Math.random() * 0.1 + 0.05).toFixed(3),
                    co2: (Math.random() * 500 + 800).toFixed(0),
                    status: i % 10 === 0 ? 'Buruk' : (i % 5 === 0 ? 'Normal' : 'Bersih')
                });
            }
            return logs.reverse();
        }

        /**
         * Menghasilkan data rekap simulasi per jam (24 entri).
         */
        function generateSimulatedHourlyRecap(count = HOURLY_RECAP_COUNT) {
            const logs = [];
            let now = new Date();
            for (let i = 0; i < count; i++) {
                const hour = (now.getHours() - i + 24) % 24;
                const timestamp = `${String(hour).padStart(2, '0')}:00`;
                logs.push({
                    timestamp: timestamp,
                    suhu: (Math.random() * 3 + 25).toFixed(1),
                    kelembaban: (Math.random() * 5 + 75).toFixed(1),
                    debu: (Math.random() * 0.05 + 0.08).toFixed(3),
                    co2: (Math.random() * 300 + 900).toFixed(0),
                    status: i % 8 === 0 ? 'Buruk' : (i % 4 === 0 ? 'Normal' : 'Bersih'),
                });
            }
            return logs.reverse(); 
        }

        /**
         * Menghasilkan data rekap simulasi per hari (7 entri).
         */
        function generateSimulatedDailyRecap(count = DAILY_RECAP_COUNT) {
            const logs = [];
            let now = new Date();
            for (let i = count - 1; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                logs.push({
                    timestamp: date.toLocaleDateString('id-ID', { weekday: 'short', day: '2-digit', month: 'short' }),
                    suhu: (Math.random() * 2 + 27).toFixed(1), 
                    kelembaban: (Math.random() * 5 + 70).toFixed(1),
                    debu: (Math.random() * 0.03 + 0.1).toFixed(3),
                    co2: (Math.random() * 200 + 1000).toFixed(0),
                    status: i === 0 ? 'Normal' : (i % 3 === 0 ? 'Buruk' : 'Bersih'),
                });
            }
            return logs;
        }

        /**
         * Menghasilkan data rekap simulasi per bulan (12 entri).
         */
        function generateSimulatedMonthlyRecap(count = MONTHLY_RECAP_COUNT) {
            const logs = [];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            let now = new Date();
            const currentMonth = now.getMonth();
            
            for (let i = 0; i < count; i++) {
                const monthIndex = (currentMonth - i + 12) % 12;
                logs.push({
                    timestamp: monthNames[monthIndex] + " " + now.getFullYear(),
                    suhu: (Math.random() * 1 + 28).toFixed(1), 
                    kelembaban: (Math.random() * 8 + 65).toFixed(1),
                    debu: (Math.random() * 0.01 + 0.12).toFixed(3),
                    co2: (Math.random() * 100 + 1100).toFixed(0),
                    status: i % 4 === 0 ? 'Buruk' : 'Bersih',
                });
            }
            return logs.reverse(); 
        }
        
        /**
         * Memilih fungsi simulasi berdasarkan periode yang dipilih.
         */
        function getLogData(period) {
            switch (period) {
                case 'minute': return generateSimulatedMinuteLog(LOG_ENTRY_COUNT);
                case 'hourly': return generateSimulatedHourlyRecap(HOURLY_RECAP_COUNT);
                case 'daily': return generateSimulatedDailyRecap(DAILY_RECAP_COUNT);
                case 'monthly': return generateSimulatedMonthlyRecap(MONTHLY_RECAP_COUNT);
                default: return [];
            }
        }

        /**
         * Mengatur periode rekap yang aktif dan merender ulang tabel.
         */
        function setRecapPeriod(period) {
            currentRecapPeriod = period;
            
            // Update Judul
            const periodTitle = period === 'minute' ? 'Per Menit' : 
                                 period === 'hourly' ? 'Per Jam' :
                                 period === 'daily' ? 'Per Hari' : 'Per Bulan';
            document.getElementById('recap-title').textContent = `Rekap Data (${periodTitle})`;
            
            // Render ulang tabel
            renderLogTable();
            
            // Update Download Button Text
            const count = period === 'minute' ? LOG_ENTRY_COUNT :
                          period === 'hourly' ? HOURLY_RECAP_COUNT :
                          period === 'daily' ? DAILY_RECAP_COUNT : MONTHLY_RECAP_COUNT;

            document.getElementById('download-csv-span').textContent = `Download CSV (${count} Entri)`;
            
            // Update button styles
            const buttons = document.querySelectorAll('#recap-period-nav button');
            buttons.forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.classList.replace('bg-gray-700', 'bg-blue-600');
                    btn.classList.replace('hover:bg-gray-600', 'hover:bg-blue-700');
                    btn.classList.remove('text-gray-300');
                    btn.classList.add('text-white');
                } else {
                    btn.classList.replace('bg-blue-600', 'bg-gray-700');
                    btn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-600');
                    btn.classList.remove('text-white');
                    btn.classList.add('text-gray-300');
                }
            });
        }
        
        /**
         * Merender tabel log ke UI berdasarkan periode aktif.
         */
        function renderLogTable() {
            // Ambil data log berdasarkan periode aktif
            const logData = getLogData(currentRecapPeriod); 
            const tableBody = document.getElementById('log-table-body');
            const tableHeader = document.getElementById('log-table-header');

            const periodLabel = currentRecapPeriod === 'minute' ? 'Per Menit' : 
                                 currentRecapPeriod === 'hourly' ? 'Per Jam' :
                                 currentRecapPeriod === 'daily' ? 'Per Hari' : 'Per Bulan';

            // Update header waktu
            tableHeader.querySelector('#timestamp-header').textContent = `Waktu (${periodLabel})`;
            
            let html = '';
            logData.forEach((log, index) => {
                // Konversi warna latar belakang status menjadi warna teks
                const statusTextColor = getStatusColor(log.status).replace('bg-', 'text-'); 
                
                html += `
                    <tr class="hover:bg-gray-700 transition duration-150 ${index % 2 === 0 ? 'bg-gray-800/50' : 'bg-gray-900/50'}">
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-400">${log.timestamp}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-red-400">${log.suhu} ${SENSOR_LABELS.suhu.unit.trim()}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-blue-400">${log.kelembaban} ${SENSOR_LABELS.kelembaban.unit.trim()}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-yellow-400">${log.debu} ${SENSOR_LABELS.debu.unit.trim()}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-green-400">${log.co2} ${SENSOR_LABELS.co2.unit.trim()}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-bold ${statusTextColor}">${log.status}</td>
                    </tr>
                `;
            });
            
            if (logData.length === 0) {
                 html = `<tr><td colspan="6" class="p-6 text-center text-gray-500">Tidak ada data rekap untuk periode ini.</td></tr>`;
            }

            tableBody.innerHTML = html;
        }
        
        // --- FETCH AND RENDER LOGS (TRENDS) ---
        async function fetchAndRenderTrends() {
            
            document.getElementById('loading-message').classList.remove('hidden');

            // Menyesuaikan warna teks dan garis pada grafik untuk tema gelap
            Chart.defaults.color = '#e5e7eb'; 
            Chart.defaults.borderColor = 'rgba(107, 114, 128, 0.5)'; 

            // ===================================
            // 1. MINUTE TRENDS (Tren Per Menit - 60 Menit Terakhir) - BARU DITAMBAH
            // ===================================
            const simulatedMinuteRecap = generateSimulatedMinuteLog(LOG_ENTRY_COUNT);
            const minuteLabels = simulatedMinuteRecap.map((_, i) => (i % 5 === 0 ? `${i} Min Ago` : '')); 
            
            const simulatedMinuteData = {
                suhu: { values: simulatedMinuteRecap.map(log => log.suhu) },
                kelembaban: { values: simulatedMinuteRecap.map(log => log.kelembaban) },
                debu: { values: simulatedMinuteRecap.map(log => log.debu) },
                co2: { values: simulatedMinuteRecap.map(log => log.co2) }
            };
            
            // 1a. Update container to hold one combined chart
            document.getElementById('minute-trends-container').innerHTML = `
                <div class="w-full p-4">
                    <div class="bg-gray-800 rounded-xl shadow-lg p-4 h-96 border border-gray-700">
                        <h3 class="text-lg font-bold text-gray-200 mb-4">Tren Per Menit (60 Menit Terakhir) - Semua Sensor</h3>
                        <canvas id="combined-minute-chart"></canvas>
                    </div>
                </div>
            `;

            // 1b. Prepare multi-dataset configuration
            const combinedMinuteDatasets = SENSORS.map(key => ({
                label: SENSOR_LABELS[key].label.split('(')[0].trim(),
                data: simulatedMinuteData[key].values,
                borderColor: SENSOR_LABELS[key].color,
                backgroundColor: SENSOR_LABELS[key].color.replace('rgb', 'rgba').replace(')', ', 0.0)'),
                fill: false, 
                tension: 0.2
            }));

            // 1c. Create the combined chart (Line type)
            const ctxMinute = document.getElementById('combined-minute-chart').getContext('2d');
            new Chart(ctxMinute, {
                type: 'line', 
                data: {
                    labels: minuteLabels,
                    datasets: combinedMinuteDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, grid: { color: 'rgba(107, 114, 128, 0.3)' } },
                        x: { 
                            grid: { color: 'rgba(107, 114, 128, 0.3)' },
                            // Menyembunyikan label yang tidak perlu untuk mengurangi kepadatan
                            ticks: { autoSkip: true, maxRotation: 0, minRotation: 0, font: { size: 10 } }
                        }
                    },
                    plugins: { 
                        legend: { 
                            display: true, 
                            labels: { color: '#e5e7eb' }
                        },
                        tooltip: {
                             callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(context.dataset.label.includes('Dust') ? 3 : 1) + SENSOR_LABELS[SENSORS.find(k => SENSOR_LABELS[k].label.includes(context.dataset.label))].unit.trim();
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });


            // ===================================
            // 2. HOURLY TRENDS (Tren Per Jam - 24 Jam Terakhir) 
            // ===================================
            const hourlyLabels = Array.from({ length: 24 }, (_, i) => `${String(i).padStart(2, '0')}:00`);
            // Data Simulasi (sama dengan yang digunakan di rekap per jam)
            const simulatedHourlyData = {
                suhu: { values: generateSimulatedHourlyRecap(HOURLY_RECAP_COUNT).map(log => log.suhu) },
                kelembaban: { values: generateSimulatedHourlyRecap(HOURLY_RECAP_COUNT).map(log => log.kelembaban) },
                debu: { values: generateSimulatedHourlyRecap(HOURLY_RECAP_COUNT).map(log => log.debu) },
                co2: { values: generateSimulatedHourlyRecap(HOURLY_RECAP_COUNT).map(log => log.co2) }
            };
            
            // 2a. Update container to hold one combined chart
            document.getElementById('hourly-trends-container').innerHTML = `
                <div class="w-full p-4">
                    <div class="bg-gray-800 rounded-xl shadow-lg p-4 h-96 border border-gray-700">
                        <h3 class="text-lg font-bold text-gray-200 mb-4">Tren Per Jam (24 Jam Terakhir) - Semua Sensor</h3>
                        <canvas id="combined-hourly-chart"></canvas>
                    </div>
                </div>
            `;

            // 2b. Prepare multi-dataset configuration
            const combinedHourlyDatasets = SENSORS.map(key => ({
                label: SENSOR_LABELS[key].label.split('(')[0].trim(),
                data: simulatedHourlyData[key].values,
                borderColor: SENSOR_LABELS[key].color,
                backgroundColor: SENSOR_LABELS[key].color.replace('rgb', 'rgba').replace(')', ', 0.0)'),
                fill: false, 
                tension: 0.2
            }));

            // 2c. Create the combined chart (Line type)
            const ctxHourly = document.getElementById('combined-hourly-chart').getContext('2d');
            new Chart(ctxHourly, {
                type: 'line', 
                data: {
                    labels: hourlyLabels,
                    datasets: combinedHourlyDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, grid: { color: 'rgba(107, 114, 128, 0.3)' } },
                        x: { grid: { color: 'rgba(107, 114, 128, 0.3)' } }
                    },
                    plugins: { 
                        legend: { 
                            display: true, 
                            labels: { color: '#e5e7eb' }
                        } 
                    }
                }
            });

            // ===================================
            // 3. DAILY TRENDS (Tren Harian - 7 Hari Terakhir) - DIGABUNGKAN
            // ===================================
            const dailyRecapData = generateSimulatedDailyRecap(DAILY_RECAP_COUNT);
            const dailyLabels = dailyRecapData.map(log => log.timestamp);

            // Data Simulasi (sama dengan yang digunakan di rekap per hari)
            const simulatedDailyData = {
                suhu: { values: dailyRecapData.map(log => log.suhu) },
                kelembaban: { values: dailyRecapData.map(log => log.kelembaban) },
                debu: { values: dailyRecapData.map(log => log.debu) },
                co2: { values: dailyRecapData.map(log => log.co2) }
            };

            // 3a. Update container to hold one combined chart
            document.getElementById('daily-trends-container').innerHTML = `
                <div class="w-full p-4">
                    <div class="bg-gray-800 rounded-xl shadow-lg p-4 h-96 border border-gray-700">
                        <h3 class="text-lg font-bold text-gray-200 mb-4">Tren Harian (7 Hari Terakhir) - Semua Sensor</h3>
                        <canvas id="combined-daily-chart"></canvas>
                    </div>
                </div>
            `;

            // 3b. Prepare multi-dataset configuration
            const combinedDailyDatasets = SENSORS.map(key => ({
                label: SENSOR_LABELS[key].label.split('(')[0].trim(), // e.g., "Temperature"
                data: simulatedDailyData[key].values,
                borderColor: SENSOR_LABELS[key].color,
                // Menggunakan fill: false agar grafik tidak saling menutupi
                backgroundColor: SENSOR_LABELS[key].color.replace('rgb', 'rgba').replace(')', ', 0.0)'), 
                fill: false, 
                tension: 0.2
            }));

            // 3c. Create the combined chart (Line type)
            const ctxDaily = document.getElementById('combined-daily-chart').getContext('2d');
            new Chart(ctxDaily, {
                type: 'line', // Menggunakan Line Chart untuk tren gabungan
                data: {
                    labels: dailyLabels,
                    datasets: combinedDailyDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: false,
                            grid: { color: 'rgba(107, 114, 128, 0.3)' } 
                        },
                        x: {
                            grid: { color: 'rgba(107, 114, 128, 0.3)' }
                        }
                    },
                    plugins: { 
                        legend: { 
                            display: true, // Tampilkan legenda untuk membedakan warna
                            labels: {
                                color: '#e5e7eb' // Warna teks legenda
                            }
                        } 
                    }
                }
            });

            // ===================================
            // 4. MONTHLY TRENDS (Tren Bulanan - 12 Bulan Terakhir) - DIGABUNGKAN
            // ===================================
            // Menggunakan data recap bulanan untuk label dan nilai
            const monthlyRecapData = generateSimulatedMonthlyRecap(MONTHLY_RECAP_COUNT);
            const monthlyLabels = monthlyRecapData.map(log => log.timestamp); 
            
            // Data Simulasi (sama dengan yang digunakan di rekap per bulan)
            const simulatedMonthlyData = {
                suhu: { values: monthlyRecapData.map(log => log.suhu) },
                kelembaban: { values: monthlyRecapData.map(log => log.kelembaban) },
                debu: { values: monthlyRecapData.map(log => log.debu) },
                co2: { values: monthlyRecapData.map(log => log.co2) }
            };

            // 4a. Update container to hold one combined chart
            document.getElementById('monthly-trends-container').innerHTML = `
                <div class="w-full p-4">
                    <div class="bg-gray-800 rounded-xl shadow-lg p-4 h-96 border border-gray-700">
                        <h3 class="text-lg font-bold text-gray-200 mb-4">Tren Bulanan (12 Bulan Terakhir) - Semua Sensor</h3>
                        <canvas id="combined-monthly-chart"></canvas>
                    </div>
                </div>
            `;

            // 4b. Prepare multi-dataset configuration
            const combinedMonthlyDatasets = SENSORS.map(key => ({
                label: SENSOR_LABELS[key].label.split('(')[0].trim(), // e.g., "Temperature"
                data: simulatedMonthlyData[key].values,
                borderColor: SENSOR_LABELS[key].color,
                backgroundColor: SENSOR_LABELS[key].color.replace('rgb', 'rgba').replace(')', ', 0.6)'), 
                fill: false,
                tension: 0.2
            }));

            // 4c. Create the combined chart (Bar type)
            const ctxMonthly = document.getElementById('combined-monthly-chart').getContext('2d');
            new Chart(ctxMonthly, {
                type: 'bar', // Menggunakan Bar Chart untuk tren bulanan
                data: {
                    labels: monthlyLabels,
                    datasets: combinedMonthlyDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, grid: { color: 'rgba(107, 114, 128, 0.3)' } },
                        x: { grid: { color: 'rgba(107, 114, 128, 0.3)' } }
                    },
                    plugins: { 
                        legend: { 
                            display: true, 
                            labels: { color: '#e5e7eb' }
                        } 
                    }
                }
            });
