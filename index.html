<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IAQ PRO v5.0</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

body{
  background:#0b0e14;
  font-family:Inter,sans-serif;
  color:#d8d9da
}
.card{
  background:#181b1f;
  border:1px solid #26292e;
  border-radius:6px
}
.nav-active{
  border-bottom:3px solid #3274d9;
  color:#3274d9
}
.active-filter{
  background:#3274d9;
  color:white
}

/* LABEL AXIS */
.axis-label{
  position:absolute;
  background:#fff;
  color:#000;
  font-size:11px;
  font-weight:700;
  padding:4px 10px;
  border-radius:6px;
  z-index:10
}
.axis-y{
  left:-42px;
  top:50%;
  transform:translateY(-50%) rotate(-90deg)
}
.axis-x{
  bottom:-30px;
  left:50%;
  transform:translateX(-50%)
}
</style>
</head>

<body class="p-4 lg:p-8">
<div class="max-w-7xl mx-auto">

<!-- HEADER -->
<header class="flex justify-between items-center mb-6 card p-4">
  <h1 class="text-xl font-black text-white">
    IAQ PRO <span class="text-[#3274d9] text-xs">v5.0</span>
  </h1>
  <nav class="flex gap-6">
    <button id="btn-dashboard" onclick="showSection('dashboard')" class="nav-active text-xs font-bold uppercase">Monitor</button>
    <button id="btn-analytic" onclick="showSection('analytic')" class="text-xs font-bold uppercase text-slate-500">Analitik</button>
  </nav>
</header>

<!-- DASHBOARD -->
<section id="section-dashboard">
  <div class="card p-5">
    <p class="text-xs text-slate-400">Status Udara</p>
    <h2 id="status" class="text-2xl font-black">MENUNGGU DATA...</h2>
    <p id="update" class="text-xs text-slate-500"></p>
  </div>
</section>

<!-- ANALITIK -->
<section id="section-analytic" class="hidden">
<div class="card p-6">

<!-- FILTER -->
<div class="flex justify-between mb-4">
  <p class="text-xs font-bold uppercase">Grafik Data</p>
  <div class="flex gap-1">
    <button class="f-btn active-filter px-3 py-1 text-xs" onclick="setFilter('sec',this)">Live</button>
    <button class="f-btn px-3 py-1 text-xs" onclick="setFilter('min',this)">Menit</button>
    <button class="f-btn px-3 py-1 text-xs" onclick="setFilter('hour',this)">Jam</button>
    <button class="f-btn px-3 py-1 text-xs" onclick="setFilter('day',this)">Hari</button>
  </div>
</div>

<!-- GRID GRAFIK -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">

<!-- SUHU -->
<div class="card p-4 h-[260px] relative">
  <div class="axis-label axis-y">Suhu (°C)</div>
  <div class="axis-label axis-x">Waktu</div>
  <canvas id="chartTemp"></canvas>
</div>

<!-- KELEMBAPAN -->
<div class="card p-4 h-[260px] relative">
  <div class="axis-label axis-y">Kelembapan (%)</div>
  <div class="axis-label axis-x">Waktu</div>
  <canvas id="chartHum"></canvas>
</div>

<!-- CO2 -->
<div class="card p-4 h-[260px] relative">
  <div class="axis-label axis-y">CO₂ (PPM)</div>
  <div class="axis-label axis-x">Waktu</div>
  <canvas id="chartCO2"></canvas>
</div>

<!-- DEBU -->
<div class="card p-4 h-[260px] relative">
  <div class="axis-label axis-y">Debu (µg/m³)</div>
  <div class="axis-label axis-x">Waktu</div>
  <canvas id="chartDust"></canvas>
</div>

</div>

</div>
</section>

</div>

<script>
// FIREBASE
firebase.initializeApp({
  apiKey:"AIzaSyAD1QPvINjWitgo_Rrj44s47Pr4S1BU_lM",
  databaseURL:"https://monitoring-kualitas-udar-8ad9d-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=firebase.database();

// STORAGE
let logs=JSON.parse(localStorage.getItem('iaq_logs'))||[];
let filter='sec';

// CHART
function makeChart(id,color){
  return new Chart(document.getElementById(id),{
    type:'line',
    data:{labels:[],datasets:[{
      data:[],
      borderColor:color,
      backgroundColor:color+'33',
      fill:true,
      tension:.3
    }]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:'#888'}},
        y:{ticks:{color:'#888'},beginAtZero:true}
      }
    }
  });
}

const cTemp=makeChart('chartTemp','#f03e3e');
const cHum =makeChart('chartHum','#339af0');
const cCO2 =makeChart('chartCO2','#51cf66');
const cDust=makeChart('chartDust','#fcc419');

// AGREGASI
function aggregate(){
  const g={};
  logs.forEach(d=>{
    const t=new Date(d.t);
    const k=
      filter==='sec'?d.ts:
      filter==='min'?`${t.getHours()}:${t.getMinutes()}`:
      filter==='hour'?`${t.getHours()}:00`:
      `${t.getDate()}/${t.getMonth()+1}`;
    if(!g[k])g[k]={s:[],h:[],c:[],d:[]};
    g[k].s.push(d.s);
    g[k].h.push(d.h);
    g[k].c.push(d.c);
    g[k].d.push(d.d);
  });
  return Object.keys(g).map(k=>({
    t:k,
    s:(g[k].s.reduce((a,b)=>a+b)/g[k].s.length).toFixed(1),
    h:(g[k].h.reduce((a,b)=>a+b)/g[k].h.length).toFixed(1),
    c:Math.round(g[k].c.reduce((a,b)=>a+b)/g[k].c.length),
    d:(g[k].d.reduce((a,b)=>a+b)/g[k].d.length).toFixed(1)
  }));
}

// RENDER
function render(){
  const d=aggregate().slice(-30);
  const l=d.map(x=>x.t);
  [cTemp,cHum,cCO2,cDust].forEach(c=>c.data.labels=l);
  cTemp.data.datasets[0].data=d.map(x=>x.s);
  cHum.data.datasets[0].data=d.map(x=>x.h);
  cCO2.data.datasets[0].data=d.map(x=>x.c);
  cDust.data.datasets[0].data=d.map(x=>x.d);
  [cTemp,cHum,cCO2,cDust].forEach(c=>c.update('none'));
}

// LISTENER
db.ref('log_sensor').limitToLast(1).on('child_added',s=>{
  const v=s.val(); if(!v)return;
  logs.push({
    t:Date.now(),
    ts:v.waktu||new Date().toLocaleTimeString(),
    s:+v.suhu,h:+v.kelembapan,c:+v.co2,d:+v.debu
  });
  if(logs.length>10000)logs.shift();
  localStorage.setItem('iaq_logs',JSON.stringify(logs));
  document.getElementById('status').textContent=`CO₂ ${v.co2} ppm`;
  document.getElementById('update').textContent=`Update ${new Date().toLocaleTimeString()}`;
  render();
});

// UI
function setFilter(f,e){
  filter=f;
  document.querySelectorAll('.f-btn').forEach(b=>b.classList.remove('active-filter'));
  e.classList.add('active-filter');
  render();
}
function showSection(s){
  document.getElementById('section-dashboard').classList.toggle('hidden',s!=='dashboard');
  document.getElementById('section-analytic').classList.toggle('hidden',s!=='analytic');
  document.getElementById('btn-dashboard').classList.toggle('nav-active',s==='dashboard');
  document.getElementById('btn-analytic').classList.toggle('nav-active',s==='analytic');
}
</script>

</body>
</html>
