#include <WiFi.h>
#include <FirebaseESP32.h>
#include <DHT.h>
#include "time.h"

/* ================== WIFI ================== */
#define WIFI_SSID     "ESP32_TEST"
#define WIFI_PASSWORD "12345678"

/* ================= FIREBASE ================= */
#define FIREBASE_HOST "monitoring-kualitas-udar-8ad9d-default-rtdb.asia-southeast1.firebasedatabase.app"
#define FIREBASE_AUTH "ISI_DENGAN_DATABASE_SECRET"

/* ================= PIN CONFIG ================= */
#define DHTPIN 27
#define DHTTYPE DHT22

#define MQ135_PIN 34
#define DUST_LED  25
#define DUST_PIN  35

#define BUZZER_PIN 26

/* ================= OBJECT ================= */
FirebaseData fbdo;
FirebaseConfig config;
FirebaseAuth auth;
DHT dht(DHTPIN, DHTTYPE);

/* ================= VAR ================= */
unsigned long lastSend = 0;

/* ================= FUNCTION ================= */
float readDust() {
  digitalWrite(DUST_LED, LOW);
  delayMicroseconds(280);
  int adc = analogRead(DUST_PIN);
  delayMicroseconds(40);
  digitalWrite(DUST_LED, HIGH);

  float voltage = adc * (3.3 / 4095.0);
  float dust = max(0.0, (voltage - 0.9) * 1000.0);
  return dust;
}

float readCO2() {
  int adc = analogRead(MQ135_PIN);
  float voltage = adc * (3.3 / 4095.0);
  return voltage * 1000 + 400; // estimasi
}

String airStatus(float co2, float dust) {
  if (co2 > 1200 || dust > 150) return "BURUK";
  if (co2 > 800 || dust > 75) return "SEDANG";
  return "BAIK";
}

/* ================= SETUP ================= */
void setup() {
  Serial.begin(115200);

  pinMode(DUST_LED, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  digitalWrite(DUST_LED, HIGH);
  digitalWrite(BUZZER_PIN, LOW);

  dht.begin();

  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connecting WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500); Serial.print(".");
  }
  Serial.println("\nWiFi Connected");

  config.host = FIREBASE_HOST;
  config.signer.tokens.legacy_token = FIREBASE_AUTH;
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  configTime(7 * 3600, 0, "pool.ntp.org");
}

/* ================= LOOP ================= */
void loop() {
  if (millis() - lastSend >= 3000) {
    lastSend = millis();

    float suhu = dht.readTemperature();
    float hum  = dht.readHumidity();
    float co2  = readCO2();
    float dust = readDust();

    if (isnan(suhu) || isnan(hum)) {
      Serial.println("DHT Error");
      return;
    }

    String status = airStatus(co2, dust);
    if (status == "BURUK") {
      digitalWrite(BUZZER_PIN, HIGH);
    } else {
      digitalWrite(BUZZER_PIN, LOW);
    }

    time_t now;
    time(&now);

    FirebaseJson json;
    json.set("suhu", suhu);
    json.set("kelembapan", hum);
    json.set("co2", co2);
    json.set("debu", dust);
    json.set("status", status);
    json.set("timestamp", now);

    // ================= LIVE =================
    Firebase.setJSON(fbdo, "/latest_sensor", json);

    // ================= HISTORI =================
    Firebase.pushJSON(fbdo, "/log_sensor", json);

    Serial.println("Data sent:");
    Serial.printf("T:%.1f H:%.1f CO2:%.0f Dust:%.0f Status:%s\n",
                  suhu, hum, co2, dust, status.c_str());
  }
}
