<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAQ Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gauge.js/dist/gauge.min.js"></script> ⚠️
    
    <style>
        :root { font-family: 'Inter', sans-serif; }
        .log-table th {
            @apply px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider bg-gray-700;
        }
        /* Tambahkan style untuk Gauge agar terlihat lebih bersih */
        .gauge-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
    </style>
    
    <script>
        // ==========================================
        // 1. FIREBASE CONFIGURATION (WAJIB DIGANTI)
        // ==========================================
        let firebaseConfig = {
            // Placeholder: GANTI dengan FIREBASE CONFIG Anda
            apiKey: "AIzaSyAD1QPvINjWitgo_Rrj44s47Pr4S1BU_lM",
            databaseURL: "https://monitoring-kualitas-udar-8ad9d-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "monitoring-kualitas-udar-8ad9d",
        };
        
        if (typeof __firebase_config !== 'undefined') {
            try {
                const envConfig = JSON.parse(__firebase_config);
                firebaseConfig = { ...firebaseConfig, ...envConfig };
            } catch (e) {
                console.error("Gagal memparsing __firebase_config:", e);
            }
        }

        // ==========================================
        // 2. GLOBAL VARIABLES
        // ==========================================
        const SENSORS = ['suhu', 'kelembaban', 'debu', 'co2'];
        const SENSOR_LABELS = {
            suhu: { label: 'Temperature (°C)', unit: ' °C', color: 'rgb(255, 99, 132)' }, // Merah
            kelembaban: { label: 'Humidity (%)', unit: ' %', color: 'rgb(54, 162, 235)' }, // Biru
            debu: { label: 'Dust (mg/m³)', unit: ' mg/m³', color: 'rgb(255, 205, 86)' }, // Kuning
            co2: { label: 'CO2 (ppm)', unit: ' ppm', color: 'rgb(75, 192, 192)' } // Hijau
        };
        
        let app;
        let db;
        let currentView = 'dashboard';
        let currentRecapPeriod = 'minute';
        
        // NEW: Objek untuk menyimpan instance Gauge
        const gauges = {}; 
        
        // Jumlah entri yang ditampilkan di tabel log untuk setiap periode
        const LOG_ENTRY_COUNT = 60; // 60 minutes (1 hour)
        const HOURLY_RECAP_COUNT = 24; // 24 hours (1 day)
        const DAILY_RECAP_COUNT = 7; // 7 days (1 week)
        const MONTHLY_RECAP_COUNT = 12; // 12 months (1 year)

        // ==========================================
        // 3. UTILITY FUNCTIONS
        // ==========================================

        function switchView(view) {
            currentView = view;
            document.getElementById('dashboard-section').classList.toggle('hidden', view !== 'dashboard');
            document.getElementById('recap-section').classList.toggle('hidden', view !== 'recap');
            
            // Update button styles
            document.getElementById('nav-dashboard').className = view === 'dashboard' 
                ? "px-6 py-2 rounded-full font-semibold transition duration-300 bg-blue-600 hover:bg-blue-700 text-white shadow-lg"
                : "px-6 py-2 rounded-full font-semibold transition duration-300 bg-gray-700 hover:bg-gray-600 text-gray-300";
            
            document.getElementById('nav-recap').className = view === 'recap' 
                ? "px-6 py-2 rounded-full font-semibold transition duration-300 bg-blue-600 hover:bg-blue-700 text-white shadow-lg"
                : "px-6 py-2 rounded-full font-semibold transition duration-300 bg-gray-700 hover:bg-gray-600 text-gray-300";

            if (view === 'recap') {
                // Saat beralih ke rekap, render log data dan atur periode awal
                setRecapPeriod(currentRecapPeriod); 
            }
        }

        function getCurrentFormattedTime() {
            return new Date().toLocaleString('id-ID', {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                timeZoneName: 'short'
            });
        }
        
        function getStatusColor(status) {
            switch (status) {
                case 'Bersih': return 'bg-green-600';
                case 'Normal': return 'bg-yellow-600';
                case 'Buruk': return 'bg-red-600';
                default: return 'bg-gray-600';
            }
        }
        
        function downloadLogAsCSV() {
            const period = currentRecapPeriod;
            const logs = getLogData(period);
            
            if (logs.length === 0) {
                console.warn("Tidak ada data log untuk diunduh.");
                return;
            }

            // 1. Header CSV
            const headers = [
                `Waktu (Per ${period})`, 
                "Suhu (C)", 
                "Kelembaban (%)", 
                "Debu (mg/m³)", 
                "CO2 (ppm)", 
                "Status"
            ];
            let csvContent = headers.join(";") + "\n"; // Menggunakan semicolon sebagai delimiter

            // 2. Data CSV
            logs.forEach(log => {
                const row = [
                    `"${log.timestamp}"`,
                    log.suhu,
                    log.kelembaban,
                    log.debu,
                    log.co2,
                    log.status
                ];
                csvContent += row.join(";") + "\n";
            });

            // 3. Memicu Unduhan
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            
            const now = new Date();
            const filename = `IAQ_Recap_${period}_${now.toISOString().split('T')[0]}.csv`;
            
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }


        // ==========================================
        // 4. DATA FETCHING & RENDERING (DASHBOARD - GAUGE)
        // ==========================================
        
        const GAUGE_CONFIG = {
            suhu: { max: 50, thresholds: { 0: { color: "#5cb85c" }, 30: { color: "#f0ad4e" }, 40: { color: "#d9534f" } }, unit: '°C' },
            kelembaban: { max: 100, thresholds: { 0: { color: "#d9534f" }, 40: { color: "#f0ad4e" }, 60: { color: "#5cb85c" } }, unit: '%' },
            debu: { max: 0.5, thresholds: { 0: { color: "#5cb85c" }, 0.1: { color: "#f0ad4e" }, 0.3: { color: "#d9534f" } }, unit: 'mg/m³' },
            co2: { max: 2000, thresholds: { 0: { color: "#5cb85c" }, 1000: { color: "#f0ad4e" }, 1500: { color: "#d9534f" } }, unit: 'ppm' }
        };

        const gaugeOptions = {
            angle: 0.15,
            lineWidth: 0.44,
            radiusScale: 1,
            pointer: { length: 0.6, strokeWidth: 0.035, color: '#000000' },
            staticLabels: {
                font: "10px sans-serif",
                labels: [0, 25, 50, 75, 100],
                color: "#e5e7eb",
                fractionDigits: 0
            },
            staticZones: [],
            limitMax: false,
            limitMin: false,
            highDpiSupport: true,
            renderTo: null
        };
        
        function initOrUpdateGauge(key, value) {
            const config = GAUGE_CONFIG[key];
            const elementId = `gauge-${key}`;
            // Pastikan nilai adalah angka dan dibulatkan sesuai kebutuhan
            const valueToDisplay = parseFloat(value).toFixed(key === 'debu' ? 3 : 1);
            
            // 1. Buat Static Zones
            const zones = [];
            let currentStart = 0;
            let lastColor = '';
            
            const sortedThresholds = Object.keys(config.thresholds).sort((a, b) => parseFloat(a) - parseFloat(b));

            sortedThresholds.forEach(thresholdStr => {
                const threshold = parseFloat(thresholdStr);
                const color = config.thresholds[thresholdStr].color;
                
                if (threshold > currentStart) {
                    zones.push({
                        strokeStyle: lastColor || '#6c757d', // Warna abu-abu default jika tidak ada
                        min: currentStart,
                        max: threshold
                    });
                }
                currentStart = threshold;
                lastColor = color;
            });
            
            zones.push({
                strokeStyle: lastColor || '#6c757d',
                min: currentStart,
                max: config.max
            });

            // 2. Inisialisasi Gauge jika belum ada
            if (!gauges[key]) {
                const target = document.getElementById(elementId);
                if (!target) return;

                // Sesuaikan Static Labels agar proporsional
                const labels = [config.max * 0.25, config.max * 0.50, config.max * 0.75, config.max].map(v => v.toFixed(key === 'debu' ? 3 : 1));
                labels.unshift(0); // Tambahkan 0 di awal
                
                const opts = {
                    ...gaugeOptions,
                    staticZones: zones,
                    limitMax: true,
                    maxValue: config.max,
                    renderTo: target,
                    staticLabels: {
                        ...gaugeOptions.staticLabels,
                        labels: labels
                    },
                    // Label kustom untuk nilai saat ini
                    label: function(value) {
                        return value.toFixed(key === 'debu' ? 3 : 1) + config.unit;
                    }
                };
                
                gauges[key] = new Gauge(opts).set(valueToDisplay);
                
            } else {
                // 3. Update Gauge jika sudah ada
                gauges[key].set(valueToDisplay);
            }
        }

        // --- FETCH REALTIME STATUS (Spidometer) ---
        function listenForCurrentStatus() {
            db.ref('/IAQ').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const realtimeTimestamp = getCurrentFormattedTime();
                    
                    // Update header status
                    const statusDiv = document.getElementById('iaq-status');
                    const color = getStatusColor(data.status);
                    statusDiv.className = `p-4 text-white font-bold rounded-xl shadow-xl text-center mb-4 ${color}`;
                    statusDiv.innerHTML = `
                        <p class="text-2xl">${data.status.toUpperCase()}</p>
                        <p class="text-sm mt-1">Kualitas Udara Terkini</p>
                    `;

                    // Update timestamp display
                    const timeDiv = document.getElementById('last-updated-time');
                    timeDiv.innerHTML = `<p class="text-sm text-gray-400 text-center mt-2">Data terakhir diperbarui pada: <strong class="text-gray-100">${realtimeTimestamp}</strong></p>`;
                    
                    // Update Gauge (Spidometer)
                    SENSORS.forEach(key => {
                        if (data[key] !== undefined) {
                            initOrUpdateGauge(key, data[key]);
                        }
                    });
                    
                }
            }, (error) => {
                console.error("Error reading IAQ data:", error);
                document.getElementById('iaq-status').textContent = "Status: Gagal memuat data.";
            });
        }


        // ==========================================
        // 5. DATA LOG SIMULATION (RECAP)
        // ==========================================
        
        function generateSimulatedMinuteLog(count = LOG_ENTRY_COUNT) {
            const logs = [];
            let now = new Date();
            for (let i = 0; i < count; i++) {
                const timestamp = new Date(now.getTime() - i * 60000); // Interval 1 menit
                logs.push({
                    timestamp: timestamp.toLocaleString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' }),
                    suhu: (Math.random() * 5 + 20).toFixed(1),
                    kelembaban: (Math.random() * 10 + 70).toFixed(1),
                    debu: (Math.random() * 0.1 + 0.05).toFixed(3),
                    co2: (Math.random() * 500 + 800).toFixed(0),
                    status: i % 10 === 0 ? 'Buruk' : (i % 5 === 0 ? 'Normal' : 'Bersih')
                });
            }
            return logs.reverse();
        }

        function generateSimulatedHourlyRecap(count = HOURLY_RECAP_COUNT) {
            const logs = [];
            let now = new Date();
            for (let i = 0; i < count; i++) {
                const hour = (now.getHours() - i + 24) % 24;
                const timestamp = `${String(hour).padStart(2, '0')}:00`;
                logs.push({
                    timestamp: timestamp,
                    suhu: (Math.random() * 3 + 25).toFixed(1),
                    kelembaban: (Math.random() * 5 + 75).toFixed(1),
                    debu: (Math.random() * 0.05 + 0.08).toFixed(3),
                    co2: (Math.random() * 300 + 900).toFixed(0),
                    status: i % 8 === 0 ? 'Buruk' : (i % 4 === 0 ? 'Normal' : 'Bersih'),
                });
            }
            return logs.reverse(); 
        }

        function generateSimulatedDailyRecap(count = DAILY_RECAP_COUNT) {
            const logs = [];
            let now = new Date();
            for (let i = count - 1; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                logs.push({
                    timestamp: date.toLocaleDateString('id-ID', { weekday: 'short', day: '2-digit', month: 'short' }),
                    suhu: (Math.random() * 2 + 27).toFixed(1), 
                    kelembaban: (Math.random() * 5 + 70).toFixed(1),
                    debu: (Math.random() * 0.03 + 0.1).toFixed(3),
                    co2: (Math.random() * 200 + 1000).toFixed(0),
                    status: i === 0 ? 'Normal' : (i % 3 === 0 ? 'Buruk' : 'Bersih'),
                });
            }
            return logs;
        }

        function generateSimulatedMonthlyRecap(count = MONTHLY_RECAP_COUNT) {
            const logs = [];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            let now = new Date();
            const currentMonth = now.getMonth();
            
            for (let i = 0; i < count; i++) {
                const monthIndex = (currentMonth - i + 12) % 12;
                logs.push({
                    timestamp: monthNames[monthIndex] + " " + now.getFullYear(),
                    suhu: (Math.random() * 1 + 28).toFixed(1), 
                    kelembaban: (Math.random() * 8 + 65).toFixed(1),
                    debu: (Math.random() * 0.01 + 0.12).toFixed(3),
                    co2: (Math.random() * 100 + 1100).toFixed(0),
                    status: i % 4 === 0 ? 'Buruk' : 'Bersih',
                });
            }
            return logs.reverse(); 
        }
        
        function getLogData(period) {
            switch (period) {
                case 'minute': return generateSimulatedMinuteLog(LOG_ENTRY_COUNT);
                case 'hourly': return generateSimulatedHourlyRecap(HOURLY_RECAP_COUNT);
                case 'daily': return generateSimulatedDailyRecap(DAILY_RECAP_COUNT);
                case 'monthly': return generateSimulatedMonthlyRecap(MONTHLY_RECAP_COUNT);
                default: return [];
            }
        }

        /**
         * Mengatur periode rekap yang aktif dan merender ulang tabel.
         * Judul H2 statis dipertahankan (perbaikan dari permintaan sebelumnya)
         */
        function setRecapPeriod(period) {
            currentRecapPeriod = period;
            
            // --- BAGIAN INI DIKOMEN AGAR JUDUL H2 TETAP STATIS ---
            // const periodTitle = period === 'minute' ? 'Per Menit' : 
            //                      period === 'hourly' ? 'Per Jam' :
            //                      period === 'daily' ? 'Per Hari' : 'Per Bulan';
            // document.getElementById('recap-title').textContent = `Rekap Data (${periodTitle})`;
            // --------------------------------------------------------
            
            renderLogTable();
            
            // Update Download Button Text
            const count = period === 'minute' ? LOG_ENTRY_COUNT :
                          period === 'hourly' ? HOURLY_RECAP_COUNT :
                          period === 'daily' ? DAILY_RECAP_COUNT : MONTHLY_RECAP_COUNT;

            document.getElementById('download-csv-span').textContent = `Download CSV (${count} Entri)`;
            
            // Update button styles
            const buttons = document.querySelectorAll('#recap-period-nav button');
            buttons.forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.classList.replace('bg-gray-700', 'bg-blue-600');
                    btn.classList.replace('hover:bg-gray-600', 'hover:bg-blue-700');
                    btn.classList.remove('text-gray-300');
                    btn.classList.add('text-white');
                } else {
                    btn.classList.replace('bg-blue-600', 'bg-gray-700');
                    btn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-600');
                    btn.classList.remove('text-white');
                    btn.classList.add('text-gray-300');
                }
            });
        }
        
        function renderLogTable() {
            const logData = getLogData(currentRecapPeriod); 
            const tableBody = document.getElementById('log-table-body');
            const tableHeader = document.getElementById('log-table-header');

            const periodLabel = currentRecapPeriod === 'minute' ? 'Per Menit' : 
                                 currentRecapPeriod === 'hourly' ? 'Per Jam' :
                                 currentRecapPeriod === 'daily' ? 'Per Hari' : 'Per Bulan';

            // Update header kolom "Waktu"
            tableHeader.querySelector('#timestamp-header').textContent = `Waktu (${periodLabel})`;
            
            let html = '';
            logData.forEach((log, index) => {
                const statusTextColor = getStatusColor(log.status).replace('bg-', 'text-'); 
                
                html += `
                    <tr class="hover:bg-gray-700 transition duration-150 ${index % 2 === 0 ? 'bg-gray-800/50' : 'bg-gray-900/50'}">
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-400">${log.timestamp}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-red-400">${log.suhu} ${SENSOR_LABELS.suhu.unit.trim()}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-blue-400">${log.kelembaban} ${SENSOR_LABELS.kelembaban.unit.trim()}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-yellow-400">${log.debu} ${SENSOR_LABELS.debu.unit.trim()}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-green-400">${log.co2} ${SENSOR_LABELS.co2.unit.trim()}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-bold ${statusTextColor}">${log.status}</td>
                    </tr>
                `;
            });
            
            if (logData.length === 0) {
                html = `<tr><td colspan="6" class="p-6 text-center text-gray-500">Tidak ada data rekap untuk periode ini.</td></tr>`;
            }

            tableBody.innerHTML = html;
        }
        
        // ==========================================
        // 6. TRENDS CHART RENDERING
        // ==========================================

        async function fetchAndRenderTrends() {
            document.getElementById('loading-message').classList.remove('hidden');

            Chart.defaults.color = '#e5e7eb'; 
            Chart.defaults.borderColor = 'rgba(107, 114, 128, 0.5)'; 

            // ... (Fungsi Chart.js lainnya, sama seperti sebelumnya) ...
            
            // --- MINUTE TRENDS (60 Menit Terakhir) ---
            const simulatedMinuteRecap = generateSimulatedMinuteLog(LOG_ENTRY_COUNT);
            const minuteLabels = simulatedMinuteRecap.map((_, i) => (i % 5 === 0 ? `${i} Min Ago` : '')); 
            
            const simulatedMinuteData = {
                suhu: { values: simulatedMinuteRecap.map(log => log.suhu) },
                kelembaban: { values: simulatedMinuteRecap.map(log => log.kelembaban) },
                debu: { values: simulatedMinuteRecap.map(log => log.debu) },
                co2: { values: simulatedMinuteRecap.map(log => log.co2) }
            };
            
            document.getElementById('minute-trends-container').innerHTML = `
                <div class="w-full p-4">
                    <div class="bg-gray-800 rounded-xl shadow-lg p-4 h-96 border border-gray-700">
                        <h3 class="text-lg font-bold text-gray-200 mb-4">Tren Per Menit (60 Menit Terakhir) - Semua Sensor</h3>
                        <canvas id="combined-minute-chart"></canvas>
                    </div>
                </div>
            `;

            const combinedMinuteDatasets = SENSORS.map(key => ({
                label: SENSOR_LABELS[key].label.split('(')[0].trim(),
                data: simulatedMinuteData[key].values,
                borderColor: SENSOR_LABELS[key].color,
                backgroundColor: SENSOR_LABELS[key].color.replace('rgb', 'rgba').replace(')', ', 0.0)'),
                fill: false, 
                tension: 0.2
            }));

            const ctxMinute = document.getElementById('combined-minute-chart').getContext('2d');
            new Chart(ctxMinute, {
                type: 'line', 
                data: {
                    labels: minuteLabels,
                    datasets: combinedMinuteDatasets
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, grid: { color: 'rgba(107, 114, 128, 0.3)' } },
                        x: { grid: { color: 'rgba(107, 114, 128, 0.3)' }, ticks: { autoSkip: true, maxRotation: 0, minRotation: 0, font: { size: 10 } } }
                    },
                    plugins: { 
                        legend: { display: true, labels: { color: '#e5e7eb' } },
                        tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     let label = context.dataset.label || '';
                                     if (label) { label += ': '; }
                                     if (context.parsed.y !== null) {
                                         const key = SENSORS.find(k => SENSOR_LABELS[k].label.includes(context.dataset.label));
                                         label += context.parsed.y.toFixed(key === 'debu' ? 3 : 1) + SENSOR_LABELS[key].unit.trim();
                                     }
                                     return label;
                                 }
                             }
                        }
                    }
                }
            });


            // --- HOURLY TRENDS (24 Jam Terakhir) ---
            const hourlyLabels = Array.from({ length: 24 }, (_, i) => `${String(i).padStart(2, '0')}:00`);
            const simulatedHourlyData = {
                suhu: { values: generateSimulatedHourlyRecap(HOURLY_RECAP_COUNT).map(log => log.suhu) },
                kelembaban: { values: generateSimulatedHourlyRecap(HOURLY_RECAP_COUNT).map(log => log.kelembaban) },
                debu: { values: generateSimulatedHourlyRecap(HOURLY_RECAP_COUNT).map(log => log.debu) },
                co2: { values: generateSimulatedHourlyRecap(HOURLY_RECAP_COUNT).map(log => log.co2) }
            };
            
            document.getElementById('hourly-trends-container').innerHTML = `
                <div class="w-full p-4">
                    <div class="bg-gray-800 rounded-xl shadow-lg p-4 h-96 border border-gray-700">
                        <h3 class="text-lg font-bold text-gray-200 mb-4">Tren Per Jam (24 Jam Terakhir) - Semua Sensor</h3>
                        <canvas id="combined-hourly-chart"></canvas>
                    </div>
                </div>
            `;

            const combinedHourlyDatasets = SENSORS.map(key => ({
                label: SENSOR_LABELS[key].label.split('(')[0].trim(),
                data: simulatedHourlyData[key].values,
                borderColor: SENSOR_LABELS[key].color,
                backgroundColor: SENSOR_LABELS[key].color.replace('rgb', 'rgba').replace(')', ', 0.0)'),
                fill: false, 
                tension: 0.2
            }));

            const ctxHourly = document.getElementById('combined-hourly-chart').getContext('2d');
            new Chart(ctxHourly, {
                type: 'line', 
                data: {
                    labels: hourlyLabels,
                    datasets: combinedHourlyDatasets
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, grid: { color: 'rgba(107, 114, 128, 0.3)' } },
                        x: { grid: { color: 'rgba(107, 114, 128, 0.3)' } }
                    },
                    plugins: { legend: { display: true, labels: { color: '#e5e7eb' } } }
                }
            });

            // --- DAILY TRENDS (7 Hari Terakhir) ---
            const dailyRecapData = generateSimulatedDailyRecap(DAILY_RECAP_COUNT);
            const dailyLabels = dailyRecapData.map(log => log.timestamp);

            const simulatedDailyData = {
                suhu: { values: dailyRecapData.map(log => log.suhu) },
                kelembaban: { values: dailyRecapData.map(log => log.kelembaban) },
                debu: { values: dailyRecapData.map(log => log.debu) },
                co2: { values: dailyRecapData.map(log => log.co2) }
            };

            document.getElementById('daily-trends-container').innerHTML = `
                <div class="w-full p-4">
                    <div class="bg-gray-800 rounded-xl shadow-lg p-4 h-96 border border-gray-700">
                        <h3 class="text-lg font-bold text-gray-200 mb-4">Tren Harian (7 Hari Terakhir) - Semua Sensor</h3>
                        <canvas id="combined-daily-chart"></canvas>
                    </div>
                </div>
            `;

            const combinedDailyDatasets = SENSORS.map(key => ({
                label: SENSOR_LABELS[key].label.split('(')[0].trim(),
                data: simulatedDailyData[key].values,
                borderColor: SENSOR_LABELS[key].color,
                backgroundColor: SENSOR_LABELS[key].color.replace('rgb', 'rgba').replace(')', ', 0.0)'), 
                fill: false, 
                tension: 0.2
            }));

            const ctxDaily = document.getElementById('combined-daily-chart').getContext('2d');
            new Chart(ctxDaily, {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: combinedDailyDatasets
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, grid: { color: 'rgba(107, 114, 128, 0.3)' } },
                        x: { grid: { color: 'rgba(107, 114, 128, 0.3)' } }
                    },
                    plugins: { legend: { display: true, labels: { color: '#e5e7eb' } } }
                }
            });

            // --- MONTHLY TRENDS (12 Bulan Terakhir) ---
            const monthlyRecapData = generateSimulatedMonthlyRecap(MONTHLY_RECAP_COUNT);
            const monthlyLabels = monthlyRecapData.map(log => log.timestamp); 
            
            const simulatedMonthlyData = {
                suhu: { values: monthlyRecapData.map(log => log.suhu) },
                kelembaban: { values: monthlyRecapData.map(log => log.kelembaban) },
                debu: { values: monthlyRecapData.map(log => log.debu) },
                co2: { values: monthlyRecapData.map(log => log.co2) }
            };

            document.getElementById('monthly-trends-container').innerHTML = `
                <div class="w-full p-4">
                    <div class="bg-gray-800 rounded-xl shadow-lg p-4 h-96 border border-gray-700">
                        <h3 class="text-lg font-bold text-gray-200 mb-4">Tren Bulanan (12 Bulan Terakhir) - Semua Sensor</h3>
                        <canvas id="combined-monthly-chart"></canvas>
                    </div>
                </div>
            `;

            const combinedMonthlyDatasets = SENSORS.map(key => ({
                label: SENSOR_LABELS[key].label.split('(')[0].trim(),
                data: simulatedMonthlyData[key].values,
                borderColor: SENSORS.color,
                backgroundColor: SENSOR_LABELS[key].color.replace('rgb', 'rgba').replace(')', ', 0.6)'), 
                fill: false,
                tension: 0.2
            }));

            const ctxMonthly = document.getElementById('combined-monthly-chart').getContext('2d');
            new Chart(ctxMonthly, {
                type: 'bar', // Menggunakan Bar Chart
                data: {
                    labels: monthlyLabels,
                    datasets: combinedMonthlyDatasets
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, grid: { color: 'rgba(107, 114, 128, 0.3)' } },
                        x: { grid: { color: 'rgba(107, 114, 128, 0.3)' } }
                    },
                    plugins: { legend: { display: true, labels: { color: '#e5e7eb' } } }
                }
            });
            
            document.getElementById('loading-message').classList.add('hidden');
        }

        // ==========================================
        // 7. INITIALIZATION
        // ==========================================
        window.onload = () => {
            try {
                app = firebase.initializeApp(firebaseConfig);
                db = app.database();
                listenForCurrentStatus();
                fetchAndRenderTrends();
                switchView('dashboard'); // Tampilkan Dashboard saat startup
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('iaq-status').textContent = `Status: GAGAL KONEKSI. Pastikan firebaseConfig sudah benar. Error: ${error.message}`;
            }
        };

    </script>
</head>

<body class="bg-gray-900 min-h-screen text-gray-100 pb-12">

    <header class="bg-gray-800 shadow-xl sticky top-0 z-10">
        <div class="container mx-auto p-4 flex justify-between items-center">
            <h1 class="text-xl font-extrabold text-blue-500">IAQ Monitor</h1>
            <nav class="space-x-4">
                <button id="nav-dashboard" onclick="switchView('dashboard')" class="px-6 py-2 rounded-full font-semibold transition duration-300 bg-blue-600 hover:bg-blue-700 text-white shadow-lg">Dashboard</button>
                <button id="nav-recap" onclick="switchView('recap')" class="px-6 py-2 rounded-full font-semibold transition duration-300 bg-gray-700 hover:bg-gray-600 text-gray-300">Rekap Data</button>
            </nav>
        </div>
    </header>

    <main class="mt-8">
        <section id="dashboard-section" class="container mx-auto p-4">
            
            <div id="iaq-status" class="p-4 text-white font-bold rounded-xl shadow-xl text-center mb-4 bg-gray-600">Loading Status...</div>
            <div id="last-updated-time"></div>

            <h2 class="text-2xl font-bold text-gray-200 mt-8 mb-4">Data Realtime (Spidometer)</h2>
            <div id="gauge-container" class="grid grid-cols-2 lg:grid-cols-4 gap-6 p-4 rounded-xl bg-gray-900 border border-gray-700 shadow-inner">
                
                <div class="p-2 bg-gray-800 rounded-xl shadow-md border border-gray-700">
                    <h3 class="text-sm text-gray-400 text-center mb-1">Temperature (°C)</h3>
                    <div id="gauge-suhu" class="gauge-container h-40"></div>
                </div>
                
                <div class="p-2 bg-gray-800 rounded-xl shadow-md border border-gray-700">
                    <h3 class="text-sm text-gray-400 text-center mb-1">Humidity (%)</h3>
                    <div id="gauge-kelembaban" class="gauge-container h-40"></div>
                </div>
                
                <div class="p-2 bg-gray-800 rounded-xl shadow-md border border-gray-700">
                    <h3 class="text-sm text-gray-400 text-center mb-1">Dust (mg/m³)</h3>
                    <div id="gauge-debu" class="gauge-container h-40"></div>
                </div>
                
                <div class="p-2 bg-gray-800 rounded-xl shadow-md border border-gray-700">
                    <h3 class="text-sm text-gray-400 text-center mb-1">CO2 (ppm)</h3>
                    <div id="gauge-co2" class="gauge-container h-40"></div>
                </div>
            </div>

            <h2 class="text-2xl font-bold text-gray-200 mt-8 mb-4">Tren Data Sensor</h2>
            <div id="loading-message" class="text-center text-blue-400 p-6 hidden">Memuat data tren dan grafik...</div>
            
            <div id="minute-trends-container" class="grid grid-cols-1 gap-6"></div>
            <div id="hourly-trends-container" class="grid grid-cols-1 gap-6"></div>
            <div id="daily-trends-container" class="grid grid-cols-1 gap-6"></div>
            <div id="monthly-trends-container" class="grid grid-cols-1 gap-6"></div>

        </section>

        <section id="recap-section" class="container mx-auto p-4 hidden">
            
            <h2 id="recap-title" class="text-3xl font-bold text-gray-100 mb-6 text-center">Rekap Data Log</h2> 

            <div id="recap-period-nav" class="flex justify-center space-x-4 mb-8">
                <button data-period="minute" onclick="setRecapPeriod('minute')" class="px-4 py-2 rounded-full font-semibold transition duration-300 bg-blue-600 hover:bg-blue-700 text-white">Per Menit</button>
                <button data-period="hourly" onclick="setRecapPeriod('hourly')" class="px-4 py-2 rounded-full font-semibold transition duration-300 bg-gray-700 hover:bg-gray-600 text-gray-300">Per Jam</button>
                <button data-period="daily" onclick="setRecapPeriod('daily')" class="px-4 py-2 rounded-full font-semibold transition duration-300 bg-gray-700 hover:bg-gray-600 text-gray-300">Per Hari</button>
                <button data-period="monthly" onclick="setRecapPeriod('monthly')" class="px-4 py-2 rounded-full font-semibold transition duration-300 bg-gray-700 hover:bg-gray-600 text-gray-300">Per Bulan</button>
            </div>

            <div class="flex justify-end mb-4">
                <button onclick="downloadLogAsCSV()" class="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150 shadow-md">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    <span id="download-csv-span">Download CSV (60 Entri)</span>
                </button>
            </div>

            <div class="bg-gray-800 shadow-xl overflow-hidden rounded-xl">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700 log-table">
                        <thead class="bg-gray-700">
                            <tr id="log-table-header">
                                <th id="timestamp-header" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Waktu (Per Menit)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Suhu</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Kelembaban</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Debu</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">CO2</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="log-table-body" class="divide-y divide-gray-800">
                            </tbody>
                    </table>
                </div>
            </div>

        </section>

    </main>
</body>
</html>
