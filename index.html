<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>IAQ Dashboard Pro - Full System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .nav-btn.active { background-color: #2563eb; color: white; }
        .filter-btn.active { background-color: #2563eb; border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-white">IAQ Smart Monitoring System</h1>
            <p id="conn-text" class="text-yellow-500 animate-pulse">Menghubungkan ke Firebase...</p>
        </header>

        <div class="flex flex-wrap justify-center gap-2 mb-8">
            <button onclick="showSection('dashboard')" id="nav-dashboard" class="nav-btn bg-blue-600 px-6 py-2 rounded-lg font-bold transition active">Dashboard</button>
            <button onclick="showSection('trends')" id="nav-trends" class="nav-btn bg-gray-700 px-6 py-2 rounded-lg font-bold transition">Grafik Analitik</button>
            <button onclick="showSection('recap')" id="nav-recap" class="nav-btn bg-gray-700 px-6 py-2 rounded-lg font-bold transition">Tabel Rekap</button>
        </div>

        <div id="section-dashboard" class="content-section">
            <div id="status-box" class="p-6 rounded-2xl text-center mb-8 transition-all duration-500 bg-gray-800 border-2 border-gray-700">
                <p id="status-label" class="text-2xl font-black text-gray-500">MEMUAT DATA...</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-800 p-8 rounded-2xl border border-gray-700 text-center">
                    <p class="text-gray-400 uppercase text-sm font-bold">Suhu</p>
                    <h2 id="live-suhu" class="text-6xl font-black text-red-500">--</h2>
                    <p class="text-lg">°Celsius</p>
                </div>
                <div class="bg-gray-800 p-8 rounded-2xl border border-gray-700 text-center">
                    <p class="text-gray-400 uppercase text-sm font-bold">Kelembaban</p>
                    <h2 id="live-hum" class="text-6xl font-black text-blue-400">--</h2>
                    <p class="text-lg">% RH</p>
                </div>
            </div>
        </div>

        <div id="section-trends" class="content-section hidden">
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h3 class="text-xl font-bold">Tren Analitik</h3>
                    <div class="flex gap-1 bg-gray-900 p-1 rounded-lg" id="trend-filter">
                        <button onclick="updateFilter('min')" class="filter-btn bg-blue-600 px-4 py-1 rounded-md text-xs font-bold active">Menit</button>
                        <button onclick="updateFilter('hour')" class="filter-btn bg-gray-700 px-4 py-1 rounded-md text-xs font-bold">Jam</button>
                        <button onclick="updateFilter('day')" class="filter-btn bg-gray-700 px-4 py-1 rounded-md text-xs font-bold">Hari</button>
                        <button onclick="updateFilter('month')" class="filter-btn bg-gray-700 px-4 py-1 rounded-md text-xs font-bold">Bulan</button>
                    </div>
                </div>
                <div class="h-[400px]">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <div id="section-recap" class="content-section hidden">
            <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h3 class="text-lg font-bold text-white">Riwayat Log Teragregasi</h3>
                    <button onclick="exportCSV()" class="bg-green-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-500">Download CSV</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-900 text-gray-400 uppercase text-xs">
                            <tr>
                                <th class="p-4">Waktu / Periode</th>
                                <th class="p-4">Rata-rata Suhu</th>
                                <th class="p-4">Rata-rata Hum</th>
                                <th class="p-4">Status Terakhir</th>
                            </tr>
                        </thead>
                        <tbody id="recap-table-body" class="divide-y divide-gray-700 font-mono text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
// --- CONFIG FIREBASE ---
const firebaseConfig = {
    apiKey: "AIzaSyAD1QPvINjWitgo_Rrj44s47Pr4S1BU_lM",
    databaseURL: "https://monitoring-kualitas-udar-8ad9d-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "monitoring-kualitas-udar-8ad9d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- STATE MANAGEMENT ---
let rawLogs = JSON.parse(localStorage.getItem('iaq_logs')) || [];
let currentFilter = 'min';

// --- INITIALIZE CHART ---
const ctx = document.getElementById('trendChart').getContext('2d');
const trendChart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [
        { label: 'Suhu (°C)', data: [], borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.3 },
        { label: 'Kelembaban (%)', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3 }
    ]},
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } },
            y: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }
        },
        plugins: { legend: { labels: { color: '#f3f4f6' } } }
    }
});

// --- FIREBASE REALTIME LISTENER ---
db.ref('DHT22').on('value', (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    // Update Connection Text
    document.getElementById('conn-text').innerText = "Terhubung ke Firebase";
    document.getElementById('conn-text').classList.replace('text-yellow-500', 'text-green-500');

    // Update Dashboard UI
    document.getElementById('live-suhu').innerText = data.suhu;
    document.getElementById('live-hum').innerText = data.kelembaban;

    const isHot = parseFloat(data.suhu) > 33;
    const box = document.getElementById('status-box');
    const label = document.getElementById('status-label');
    
    box.className = `p-6 rounded-2xl text-center mb-8 border-2 transition-all ${isHot ? 'bg-red-900/30 border-red-500' : 'bg-green-900/30 border-green-500'}`;
    label.innerText = isHot ? "KONDISI: PANAS / BURUK" : "KONDISI: NORMAL / NYAMAN";
    label.className = `text-2xl font-black ${isHot ? 'text-red-500' : 'text-green-500'}`;

    // Push to Local Logs
    const logEntry = {
        t: Date.now(),
        s: parseFloat(data.suhu),
        h: parseFloat(data.kelembaban),
        st: label.innerText.split(': ')[1]
    };
    rawLogs.push(logEntry);
    if(rawLogs.length > 3000) rawLogs.shift(); // Limit agar browser tidak berat
    localStorage.setItem('iaq_logs', JSON.stringify(rawLogs));

    renderAll();
});

// --- DATA PROCESSING & AGGREGATION ---
function processAgreggation(mode) {
    const grouped = {};
    
    rawLogs.forEach(log => {
        const d = new Date(log.t);
        let key;
        if(mode === 'min') key = d.getHours() + ":" + d.getMinutes().toString().padStart(2, '0') + ":" + d.getSeconds().toString().padStart(2, '0');
        else if(mode === 'hour') key = d.getHours() + ":00";
        else if(mode === 'day') key = d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
        else if(mode === 'month') key = d.toLocaleString('id-ID', { month: 'long' });

        if(!grouped[key]) grouped[key] = { s: [], h: [], st: log.st };
        grouped[key].s.push(log.s);
        grouped[key].h.push(log.h);
    });

    return Object.keys(grouped).map(k => ({
        time: k,
        suhu: (grouped[k].s.reduce((a,b) => a+b, 0) / grouped[k].s.length).toFixed(1),
        hum: (grouped[k].h.reduce((a,b) => a+b, 0) / grouped[k].h.length).toFixed(1),
        status: grouped[k].st
    }));
}

function renderAll() {
    const data = processAgreggation(currentFilter);
    const chartData = currentFilter === 'min' ? data.slice(-20) : data;

    // Update Chart
    trendChart.data.labels = chartData.map(d => d.time);
    trendChart.data.datasets[0].data = chartData.map(d => d.suhu);
    trendChart.data.datasets[1].data = chartData.map(d => d.hum);
    trendChart.update('none'); // Update tanpa animasi agar ringan

    // Update Table Recap
    const tbody = document.getElementById('recap-table-body');
    const tableDisplay = [...data].reverse().slice(0, 50); // Tampilkan 50 baris terbaru
    tbody.innerHTML = tableDisplay.map(d => `
        <tr class="hover:bg-gray-800 transition">
            <td class="p-4 text-gray-400">${d.time}</td>
            <td class="p-4 text-red-400 font-bold">${d.suhu}°C</td>
            <td class="p-4 text-blue-400 font-bold">${d.hum}%</td>
            <td class="p-4 text-xs font-bold">${d.status}</td>
        </tr>
    `).join('');
}

// --- UI NAVIGATION ---
function showSection(id) {
    document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
    document.getElementById('section-' + id).classList.remove('hidden');
    
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active', 'bg-blue-600'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.add('bg-gray-700'));
    
    const activeBtn = document.getElementById('nav-' + id);
    activeBtn.classList.add('active', 'bg-blue-600');
    activeBtn.classList.remove('bg-gray-700');
}

function updateFilter(mode) {
    currentFilter = mode;
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-blue-600');
        btn.classList.add('bg-gray-700');
    });
    event.target.classList.add('active', 'bg-blue-600');
    event.target.classList.remove('bg-gray-700');
    renderAll();
}

function exportCSV() {
    const data = processAgreggation(currentFilter);
    let csv = "Waktu,Rata-rata Suhu,Rata-rata Kelembaban,Status\n";
    data.forEach(d => csv += `${d.time},${d.suhu},${d.hum},${d.status}\n`);
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Rekap_IAQ_${currentFilter}_${new Date().toLocaleDateString()}.csv`;
    a.click();
}

// Render awal saat load
window.onload = renderAll;
</script>
</body>
</html>
