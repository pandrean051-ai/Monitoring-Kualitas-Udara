<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Monitoring Kualitas Udara</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f6f8}
nav{display:flex;background:#1f2937;color:#fff}
nav button{flex:1;padding:12px;border:none;background:none;color:#fff;cursor:pointer}
.nav-active{background:#2563eb}
.hidden{display:none}
.container{padding:15px}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:15px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #ddd}
th{text-align:left}
.text-left{text-align:left}
</style>
</head>

<body>

<nav>
  <button id="btn-dashboard" class="nav-active" onclick="showSection('dashboard')">Dashboard</button>
  <button id="btn-recap" onclick="showSection('recap')">Analitik</button>
</nav>

<div class="container">

<!-- ================= DASHBOARD ================= -->
<div id="section-dashboard">
  <div class="card">
    <h3>Data Terakhir</h3>
    <p>Suhu: <span id="v-suhu">-</span> °C</p>
    <p>Kelembapan: <span id="v-hum">-</span> %</p>
    <p>CO₂: <span id="v-co2">-</span> ppm</p>
    <p>Debu: <span id="v-dust">-</span> µg/m³</p>
  </div>
</div>

<!-- ================= ANALITIK ================= -->
<div id="section-recap" class="hidden">

<div class="card">
  <button onclick="setFilter('sec')">Live</button>
  <button onclick="setFilter('min')">Menit</button>
  <button onclick="setFilter('hour')">Jam</button>
  <button onclick="setFilter('day')">Hari</button>
</div>

<div class="card"><canvas id="chartTemp"></canvas></div>
<div class="card"><canvas id="chartHum"></canvas></div>
<div class="card"><canvas id="chartCO2"></canvas></div>
<div class="card"><canvas id="chartDust"></canvas></div>

<div class="card">
<table>
<thead>
<tr>
  <th class="p-2">Waktu</th>
  <th class="p-2 text-left">Suhu</th>
  <th class="p-2 text-left">Hum</th>
  <th class="p-2 text-left">CO₂</th>
  <th class="p-2 text-left">Debu</th>
</tr>
</thead>
<tbody id="table-body"></tbody>
</table>
</div>

</div>
</div>

<script>
/* ================= DATA ================= */
let logData = [];
let currentFilter = 'sec';
const historyLimit = 20;

/* ================= CHART ================= */
const opt = {responsive:true,maintainAspectRatio:false};

const chartTemp = new Chart(chartTemp,{type:'line',data:{labels:[],datasets:[{label:'Suhu',data:[]}]} ,options:opt});
const chartHum  = new Chart(chartHum ,{type:'line',data:{labels:[],datasets:[{label:'Hum',data:[]}]}  ,options:opt});
const chartCO2  = new Chart(chartCO2 ,{type:'line',data:{labels:[],datasets:[{label:'CO₂',data:[]}]}  ,options:opt});
const chartDust = new Chart(chartDust,{type:'line',data:{labels:[],datasets:[{label:'Debu',data:[]}]} ,options:opt});

/* ================= UTIL ================= */
const avg = a => a.reduce((x,y)=>x+y,0)/a.length;

/* ================= FILTER ================= */
function setFilter(f){
  currentFilter = f;
  render();
}

/* ================= AGGREGATE ================= */
function getAggregated(){
  const map = {};

  logData.forEach(d=>{
    const t = new Date(d.ts);
    let key,label;

    if(currentFilter==='sec'){
      key=d.ts;
      label=t.toLocaleString('id-ID');
    }
    if(currentFilter==='min'){
      key=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes()).getTime();
      label=t.toLocaleDateString('id-ID')+' '+t.getHours().toString().padStart(2,'0')+':'+t.getMinutes().toString().padStart(2,'0');
    }
    if(currentFilter==='hour'){
      key=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours()).getTime();
      label=t.toLocaleDateString('id-ID')+' '+t.getHours().toString().padStart(2,'0')+':00';
    }
    if(currentFilter==='day'){
      key=new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime();
      label=t.toLocaleDateString('id-ID');
    }

    if(!map[key]) map[key]={label,s:[],h:[],c:[],d:[]};
    map[key].s.push(d.s);
    map[key].h.push(d.h);
    map[key].c.push(d.c);
    map[key].d.push(d.d);
  });

  return Object.keys(map).map(k=>({
    ts:+k,
    time:map[k].label,
    s:avg(map[k].s).toFixed(1),
    h:avg(map[k].h).toFixed(1),
    c:Math.round(avg(map[k].c)),
    d:avg(map[k].d).toFixed(1)
  })).sort((a,b)=>a.ts-b.ts);
}

/* ================= RENDER ================= */
function render(){
  const data = getAggregated().slice(-historyLimit);

  chartTemp.data.labels=data.map(v=>v.time);
  chartHum.data.labels=data.map(v=>v.time);
  chartCO2.data.labels=data.map(v=>v.time);
  chartDust.data.labels=data.map(v=>v.time);

  chartTemp.data.datasets[0].data=data.map(v=>v.s);
  chartHum.data.datasets[0].data=data.map(v=>v.h);
  chartCO2.data.datasets[0].data=data.map(v=>v.c);
  chartDust.data.datasets[0].data=data.map(v=>v.d);

  chartTemp.update();
  chartHum.update();
  chartCO2.update();
  chartDust.update();

  document.getElementById('table-body').innerHTML =
    [...data].reverse().map(v=>`
      <tr>
        <td>${v.time}</td>
        <td class="text-left">${v.s}</td>
        <td class="text-left">${v.h}</td>
        <td class="text-left">${v.c}</td>
        <td class="text-left">${v.d}</td>
      </tr>`).join('');
}

/* ================= NAV ================= */
function showSection(s){
  section-dashboard.classList.toggle('hidden',s!=='dashboard');
  section-recap.classList.toggle('hidden',s!=='recap');
  btn-dashboard.classList.toggle('nav-active',s==='dashboard');
  btn-recap.classList.toggle('nav-active',s==='recap');
  if(s==='recap') setTimeout(render,100);
}

/* ================= SIMULASI DATA ================= */
setInterval(()=>{
  const d={
    ts:Date.now(),
    s:25+Math.random()*2,
    h:60+Math.random()*5,
    c:800+Math.random()*300,
    d:10+Math.random()*5
  };
  logData.push(d);
  v-suhu.innerText=d.s.toFixed(1);
  v-hum.innerText=d.h.toFixed(1);
  v-co2.innerText=Math.round(d.c);
  v-dust.innerText=d.d.toFixed(1);
},3000);
</script>

</body>
</html>
