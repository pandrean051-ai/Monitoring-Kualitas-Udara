<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard IAQ - Fixed Version</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://bernii.github.io/gauge.js/dist/gauge.min.js">
    </script>

    <style>
        :root { font-family: 'Inter', sans-serif; }
        body { background-color: #0d1117; color: #c9d1d9; }

        .log-table th {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #9CA3AF;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background-color: #374151;
        }

        .gauge-container { max-height: 140px; }
    </style>
</head>
<body class="p-4">

<h1 class="text-3xl font-bold mb-4">Dashboard Kualitas Udara</h1>

<div id="iaq-status" class="p-4 text-center text-white rounded-xl mb-6 bg-gray-700">
    Memuat status...
</div>

<div id="last-updated-time" class="text-center text-gray-400 mb-6"></div>

<!-- Gauge Section -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-10">
    <div class="gauge-container text-center">
        <canvas id="gauge-suhu"></canvas>
    </div>
    <div class="gauge-container text-center">
        <canvas id="gauge-kelembaban"></canvas>
    </div>
    <div class="gauge-container text-center">
        <canvas id="gauge-debu"></canvas>
    </div>
    <div class="gauge-container text-center">
        <canvas id="gauge-co2"></canvas>
    </div>
</div>

<!-- Grafik -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
    <canvas id="suhu-chart"></canvas>
    <canvas id="kelembaban-chart"></canvas>
    <canvas id="debu-chart"></canvas>
    <canvas id="co2-chart"></canvas>
</div>

<!-- Tabel -->
<h2 class="text-xl font-bold mb-2">Riwayat Per Menit</h2>
<table class="w-full log-table">
    <thead>
        <tr>
            <th>Waktu</th>
            <th>Suhu</th>
            <th>Kelembaban</th>
            <th>Debu</th>
            <th>CO₂</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody id="minute-log-body"></tbody>
</table>

<script>
// ------------------ Konfigurasi ------------------
const SENSORS = ["suhu", "kelembaban", "debu", "co2"];
const SENSOR_LABELS = {
    suhu: { label: "Suhu", unit: "°C" },
    kelembaban: { label: "Kelembaban", unit: "%" },
    debu: { label: "Debu", unit: " mg/m³" },
    co2: { label: "CO₂", unit: " ppm" }
};

let gauges = {};
let charts = {};

// ------------------ Firebase ------------------
const firebaseConfig = {
    apiKey: "YOUR_KEY",
    authDomain: "YOUR_DOMAIN",
    databaseURL: "YOUR_DB_URL",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_STORAGE",
    messagingSenderId: "YOUR_MSG_ID",
    appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ------------------ Simulasi Data ------------------
function generateSimulatedMinuteLog(total = 60) {
    const logs = [];
    const now = new Date();
    for (let i = 0; i < total; i++) {
        const t = new Date(now.getTime() - i * 60000);
        logs.push({
            timestamp: t.toLocaleTimeString("id-ID"),
            suhu: Number((Math.random() * 5 + 20).toFixed(1)),
            kelembaban: Number((Math.random() * 10 + 70).toFixed(1)),
            debu: Number((Math.random() * 0.1 + 0.05).toFixed(3)),
            co2: Number((Math.random() * 500 + 800).toFixed(0)),
            status: "Normal"
        });
    }
    return logs.reverse();
}

// ------------------ Gauge ------------------
function createGauge(id, maxValue) {
    const opts = { angle: -0.2, lineWidth: 0.2, radiusScale: 1, pointer: { length: 0.6, strokeWidth: 4 }, limitMax: false, limitMin: false, highDpiSupport: true };
    const target = document.getElementById(id);
    const gauge = new Gauge(target).setOptions(opts);
    gauge.maxValue = maxValue;
    gauge.setMinValue(0);
    gauge.set(0);
    return gauge;
}

function initGauges() {
    gauges.suhu = createGauge("gauge-suhu", 50);
    gauges.kelembaban = createGauge("gauge-kelembaban", 100);
    gauges.debu = createGauge("gauge-debu", 1);
    gauges.co2 = createGauge("gauge-co2", 2000);
}

// ------------------ Chart ------------------
function createChart(id, label) {
    const ctx = document.getElementById(id).getContext("2d");
    return new Chart(ctx, {
        type: "line",
        data: { labels: [], datasets: [{ label, data: [], borderWidth: 2 }] },
        options: { responsive: true, plugins: { legend: { labels: { color: "white" } } }, scales: { x: { ticks: { color: "white" } }, y: { ticks: { color: "white" } } } }
    });
}

function initCharts() {
    charts.suhu = createChart("suhu-chart", "Suhu");
    charts.kelembaban = createChart("kelembaban-chart", "Kelembaban");
    charts.debu = createChart("debu-chart", "Debu");
    charts.co2 = createChart("co2-chart", "CO₂");
}

// ------------------ Load Simulasi ------------------
function loadMinuteTable(logs) {
    const tbody = document.getElementById("minute-log-body");
    tbody.innerHTML = "";
    logs.forEach(row => {
        tbody.innerHTML += `
            <tr>
                <td>${row.timestamp}</td>
                <td>${row.suhu}°C</td>
                <td>${row.kelembaban}%</td>
                <td>${row.debu} mg/m³</td>
                <td>${row.co2} ppm</td>
                <td>${row.status}</td>
            </tr>`;
    });
}

// ------------------ Realtime Firebase ------------------
function listenForRealtime() {
    const ref = db.ref("/IAQ");

    ref.on("value", snap => {
        const data = snap.val();
        if (!data) return;

        // Status Box
        const statusDiv = document.getElementById("iaq-status");
        statusDiv.textContent = data.status || "UNKNOWN";
        statusDiv.style.backgroundColor = data.status === "Buruk" ? "#dc2626" : (data.status === "Normal" ? "#facc15" : "#16a34a");

        document.getElementById("last-updated-time").innerHTML =
            `<strong>${new Date().toLocaleString("id-ID")}</strong>`;

        // Update Gauge + Chart
        SENSORS.forEach(key => {
            const val = Number(data[key]) || 0;
            if (gauges[key]) gauges[key].set(val);
            if (charts[key]) {
                const c = charts[key];
                c.data.labels.push("");
                c.data.datasets[0].data.push(val);
                if (c.data.datasets[0].data.length > 60) {
                    c.data.labels.shift();
                    c.data.datasets[0].data.shift();
                }
                c.update();
            }
        });
    });

    window.addEventListener("beforeunload", () => ref.off());
}

// ------------------ Init ------------------
function initApp() {
    initGauges();
    initCharts();

    const simulatedLogs = generateSimulatedMinuteLog();
    loadMinuteTable(simulatedLogs);

    listenForRealtime();
}

window.onload = initApp;
</script>

  <!-- Firebase SDK (Modular v9+) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // TODO: Ganti dengan konfigurasi Firebase asli kamu
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const sensorRef = ref(db, "IAQ");

    onValue(sensorRef, (snapshot) => {
      const data = snapshot.val();
      console.log(data);
      // TODO: Update UI sesuai data
    });
  </script>
</body>
</html>
